<div class="page-content-wrapper">
  <div class="page-content">
    <div class="page-bar">
      <div class="page-title-breadcrumb">
        <div class="pull-left">
          <div class="page-title"><%= __('All Admin Subscriptions') %></div>
        </div>
        <ol class="breadcrumb page-breadcrumb pull-right">
          <li>
            <i class="fa fa-home"></i>&nbsp;<a
              class="parent-item"
              href="/admin/list"
              ><%= __('Home') %></a
            >&nbsp;<i class="fa fa-angle-right"></i>
          </li>
          <li>
            <a class="parent-item" href="#"><%= __('Subscriptions') %></a
            >&nbsp;<i class="fa fa-angle-right"></i>
          </li>
        </ol>
      </div>
    </div>
    <div class="row">
      <div class="col-md-12">
        <div class="tabbable-line">
          <div class="tab-content">
            <div class="tab-pane active fontawesome-demo" id="tab1">
              <div class="row">
                <div class="col-md-12">
                  <div class="card">
                    <div class="card-body">
                      <div>
                        <% if (message !== '') { %>
                        <div
                          id="myDivSuccess"
                          class="alert alert-dismissible fade show mb-0"
                          style="
                            background-color: rgb(183, 237, 183);
                            border: none;
                            color: rgb(2, 120, 2);
                          "
                          role="alert"
                        >
                          <%= message %>
                          <button
                            type="button"
                            class="btn-close"
                            data-bs-dismiss="alert"
                            aria-label="Close"
                            onclick="hideDivSuccess()"
                          ></button>
                        </div>
                        <script>
                          function hideDivSuccess() {
                            document.getElementById(
                              "myDivSuccess"
                            ).style.display = "none";
                          }
                        </script>
                        <% } else if (error !== '') { %>
                        <div
                          id="myDiv"
                          class="alert alert-dismissible fade show mb-0"
                          style="
                            background-color: rgb(237, 183, 183);
                            border: none;
                            color: rgb(120, 2, 2);
                          "
                          role="alert"
                        >
                          <%= error %>
                          <button
                            type="button"
                            class="btn-close"
                            data-bs-dismiss="alert"
                            aria-label="Close"
                            onclick="hideDiv()"
                          ></button>
                        </div>
                        <script>
                          function hideDiv() {
                            document.getElementById("myDiv").style.display =
                              "none";
                          }
                        </script>
                        <% } %>
                      </div>

                      <!-- <table
                        class="table table-responsive custom-table table-sm"
                        id="subscriptionTable"
                      >
                        <thead>
                          <tr>
                            <th class="text-center"><%= __('S.No') %></th>
                            <th class="text-center">
                              <%= __('Admin Email') %>
                            </th>
                            <th class="text-center">
                              <%= __('Subscription Name') %>
                            </th>
                            <th class="text-center"><%= __('Price') %></th>
                            <th class="text-center"><%= __('Currency') %></th>
                            <th class="text-center"><%= __('Status') %></th>
                            <th class="text-center">
                              <%= __('Expired in Days') %>
                            </th>
                            <th class="text-center"><%= __('Actions') %></th>
                          </tr>
                        </thead>
                        <tbody>
                          <% if (totalItems) { %> <% let activeItems = []; let
                          expiredItems = []; const statusFilter = 'active';
                          items.forEach((data) => { const expirationDate = new
                          Date(data.plan_period_end); const currentDate = new
                          Date(); const daysUntilExpiration =
                          Math.floor((expirationDate - currentDate) / (1000 * 60
                          * 60 * 24)); const isActive = daysUntilExpiration >=
                          0; if (data.status === statusFilter) { if (isActive) {
                          activeItems.push({ ...data, daysUntilExpiration }); }
                          else { expiredItems.push({ ...data,
                          daysUntilExpiration }); } } }); let combinedItems =
                          activeItems.concat(expiredItems); %> <% let counter =
                          1; combinedItems.forEach((data) => { const isActive =
                          data.daysUntilExpiration >= 0; const daysColor =
                          data.daysUntilExpiration < 0 ? '#e33636' : '#26b809';
                          const actionButton = isActive ? { text:
                          __('Deactivate'), style: 'btn-danger', action:
                          'deactivate' } : { text: __('Activate'), style:
                          'btn-success', action: 'activate' }; %>
                          <tr>
                            <td class="text-center"><%= counter %></td>
                            <td class="text-center">
                              <a
                                href="#"
                                class="viewAllSubscriptions"
                                data-email="<%= data.Super_Admin_Cashier.email %>"
                                ><%= data.Super_Admin_Cashier.email %></a
                              >
                            </td>
                            <td class="text-center">
                              <%= data.Subscription.name %>
                            </td>
                            <td class="text-center">
                              <%= data.Subscription.price %>
                            </td>
                            <td class="text-center">
                              <%= data.Subscription.currency %>
                            </td>
                            <td
                              class="text-center"
                              style="color: <%= daysColor %>"
                            >
                              <%= isActive ? __('Active') : __('Expired') %>
                            </td>
                            <td
                              class="text-center"
                              style="color: <%= daysColor %>"
                            >
                              <%= data.daysUntilExpiration %>
                            </td>
                            <td class="text-center">
                              <button
                                data-id="<%= data.id %>"
                                data-action="<%= actionButton.action %>"
                                class="tblActBtn btn <%= actionButton.style %> openModal"
                                style="border: none"
                              >
                                <%= actionButton.text %>
                                <%= data.id %>
                              </button>
                            </td>
                          </tr>
                          <% counter++; %> <% }) %> <% } else { %>
                          <tr>
                            <td
                              colspan="8"
                              class="text-center dataTables_empty"
                            >
                              <%= __('No data found') %>
                            </td>
                          </tr>
                          <% } %>
                        </tbody>
                      </table> -->
                      <table
                        class="table table-responsive custom-table table-sm"
                        id="subscriptionTable"
                      >
                        <thead>
                          <tr>
                            <th class="text-center"><%= __('S.No') %></th>
                            <th class="text-center">
                              <%= __('Admin Email') %>
                            </th>
                            <th class="text-center">
                              <%= __('Subscription Name') %>
                            </th>
                            <th class="text-center"><%= __('Price') %></th>
                            <th class="text-center"><%= __('Currency') %></th>
                            <th class="text-center"><%= __('Status') %></th>
                            <th class="text-center">
                              <%= __('Expired in Days') %>
                            </th>
                            <th class="text-center"><%= __('Actions') %></th>
                          </tr>
                        </thead>
                        <tbody>
                          <% if (totalItems) { %> <% let activeItems = []; let
                          expiredItems = []; const statusFilter = 'active'; %>
                          <% items.forEach((data) => { const expirationDate =
                          new Date(data.plan_period_end); const currentDate =
                          new Date(); const daysUntilExpiration =
                          Math.floor((expirationDate - currentDate) / (1000 * 60
                          * 60 * 24)); const isActive = daysUntilExpiration >=
                          0; if (data.status === statusFilter) { if (isActive) {
                          activeItems.push({ ...data, daysUntilExpiration }); }
                          else { expiredItems.push({ ...data,
                          daysUntilExpiration }); } } }); %> <% let counter = 1;
                          let combinedItems = activeItems.concat(expiredItems);
                          combinedItems.forEach((data) => { const isActive =
                          data.daysUntilExpiration >= 0; const daysColor =
                          data.daysUntilExpiration < 0 ? '#e33636' : '#26b809';
                          const actionButton = isActive ? { text:
                          __('Deactivate'), style: 'btn-danger', action:
                          'deactivate' } : { text: __('Activate'), style:
                          'btn-success', action: 'activate' }; %>
                          <tr>
                            <td class="text-center"><%= counter %></td>
                            <td class="text-center">
                              <a
                                href="#"
                                class="viewAllSubscriptions"
                                data-email="<%= data.Super_Admin_Cashier.email %>"
                                ><%= data.Super_Admin_Cashier.email %></a
                              >
                            </td>
                            <td class="text-center">
                              <%= data.Subscription.name %>
                            </td>
                            <td class="text-center">
                              <%= data.Subscription.price %>
                            </td>
                            <td class="text-center">
                              <%= data.Subscription.currency %>
                            </td>
                            <td
                              class="text-center"
                              style="color: <%= daysColor %>"
                            >
                              <%= isActive ? __('Active') : __('Expired') %>
                            </td>
                            <td
                              class="text-center"
                              style="color: <%= daysColor %>"
                            >
                              <%= data.daysUntilExpiration %>
                            </td>
                            <td class="text-center">
                              <button
                                data-id="<%= data.id %>"
                                data-action="<%= actionButton.action %>"
                                class="tblActBtn btn <%= actionButton.style %> openModal"
                                style="border: none"
                              >
                                <%= actionButton.text %>
                              </button>
                            </td>
                          </tr>
                          <% counter++; %> <% }); %> <% } else { %>
                          <tr>
                            <td
                              colspan="8"
                              class="text-center dataTables_empty"
                            >
                              <%= __('No data found') %>
                            </td>
                          </tr>
                          <% } %>
                        </tbody>
                      </table>

                      <!-- Modal -->
                      <div
                        class="modal fade"
                        id="actionModal"
                        tabindex="-1"
                        role="dialog"
                        aria-labelledby="actionModalLabel"
                        aria-hidden="true"
                      >
                        <div class="modal-dialog" role="document">
                          <div class="modal-content">
                            <div class="modal-header">
                              <h5 class="modal-title" id="actionModalLabel">
                                Modify Subscription
                              </h5>
                              <button
                                type="button"
                                class="close"
                                data-dismiss="modal"
                                aria-label="Close"
                              >
                                <span aria-hidden="true">&times;</span>
                              </button>
                            </div>
                            <div class="modal-body">
                              <form id="modifySubscriptionForm">
                                <input
                                  type="hidden"
                                  id="subscriptionId"
                                  name="subscriptionId"
                                />
                                <input
                                  type="hidden"
                                  id="subscriptionAction"
                                  name="subscriptionAction"
                                />
                                <div
                                  class="form-group"
                                  id="expireDaysContainer"
                                >
                                  <label for="expireDays"
                                    >Days Until Expire</label
                                  >
                                  <input
                                    type="number"
                                    class="form-control"
                                    id="expireDays"
                                    name="expireDays"
                                    placeholder="Enter number of days"
                                  />
                                </div>
                                <button
                                  type="button"
                                  class="btn btn-danger"
                                  id="instantExpireBtn"
                                >
                                  Instant Expire
                                </button>
                              </form>
                            </div>
                            <div class="modal-footer">
                              <button
                                type="button"
                                class="btn btn-secondary"
                                data-dismiss="modal"
                              >
                                Close
                              </button>
                              <button
                                type="button"
                                class="btn btn-primary"
                                id="saveChangesBtn"
                              >
                                Save changes
                              </button>
                            </div>
                          </div>
                        </div>
                      </div>

                      <!-- Include jQuery and Bootstrap JS for modal functionality -->
                      <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
                      <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
                      <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>

                      <script>
                        $(document).ready(function () {
                          $(".openModal").on("click", function () {
                            const subscriptionId = $(this).data("id");
                            console.log(subscriptionId, "ssub");
                            const action = $(this).data("action");
                            $("#subscriptionId").val(subscriptionId);
                            $("#subscriptionAction").val(action);

                            if (action === "activate") {
                              $("#instantExpireBtn").hide();
                            } else {
                              $("#instantExpireBtn").show();
                            }

                            $("#actionModal").modal("show");
                          });

                          $("#instantExpireBtn").on("click", function () {
                            const subscriptionId = $("#subscriptionId").val();
                            console.log(subscriptionId, "subscrtion");
                            $.ajax({
                              url: "/admin/subscription/instantExpire",
                              method: "POST",
                              data: { id: subscriptionId },
                              success: function (response) {
                                console.log(response.data);
                                // alert("Subscription expired instantly.");
                                // location.reload();
                              },
                            });
                          });

                          $("#saveChangesBtn").on("click", function () {
                            const subscriptionId = $("#subscriptionId").val();
                            const expireDays = $("#expireDays").val();
                            const action = $("#subscriptionAction").val();

                            if (action === "activate") {
                              $.ajax({
                                url: "/admin/subscription/activate",
                                method: "POST",
                                data: {
                                  id: subscriptionId,
                                  expireDays: expireDays,
                                },
                                success: function (response) {
                                  alert("Subscription activated successfully.");
                                  location.reload();
                                },
                              });
                            } else {
                              $.ajax({
                                url: "/admin/subscription/modify",
                                method: "POST",
                                data: {
                                  id: subscriptionId,
                                  expireDays: expireDays,
                                },
                                success: function (response) {
                                  alert("Subscription modified successfully.");
                                  location.reload();
                                },
                              });
                            }
                          });
                        });
                      </script>

                      <script>
                        function capitalize(str) {
                          return str.charAt(0).toUpperCase() + str.slice(1);
                        }

                        function formatDate(dateStr) {
                          return new Date(dateStr).toLocaleDateString();
                        }

                        function paginationHelper(
                          currentPage,
                          totalPages,
                          search_text
                        ) {
                          let paginationHtml = "";

                          if (currentPage == 1) {
                            paginationHtml +=
                              '<li class="disabled"><a>' +
                              __("First") +
                              "</a></li>";
                          } else {
                            paginationHtml +=
                              '<li><a href="/admin/subscription/list?page=1&limit=10&search_text=' +
                              search_text +
                              '">' +
                              __("First") +
                              "</a></li>";
                          }

                          let startPage =
                            Number(currentPage) > 5
                              ? Number(currentPage) - 4
                              : 1;
                          if (startPage !== 1) {
                            paginationHtml +=
                              '<li class="disabled"><a>...</a></li>';
                          }

                          for (
                            let i = startPage;
                            i <= Number(currentPage) + 4 && i <= totalPages;
                            i++
                          ) {
                            if (i == currentPage) {
                              paginationHtml +=
                                '<li class="active"><a>' + i + "</a></li>";
                            } else {
                              paginationHtml +=
                                '<li><a href="/admin/subscription/list?page=' +
                                i +
                                "&limit=10&search_text=" +
                                search_text +
                                '">' +
                                i +
                                "</a></li>";
                            }

                            if (
                              i == Number(currentPage) + 4 &&
                              i < totalPages
                            ) {
                              paginationHtml +=
                                '<li class="disabled"><a>...</a></li>';
                            }
                          }

                          if (currentPage == totalPages) {
                            paginationHtml +=
                              '<li class="disabled"><a>' +
                              __("Last") +
                              "</a></li>";
                          } else {
                            paginationHtml +=
                              '<li><a href="/admin/subscription/list?page=' +
                              totalPages +
                              "&limit=10&search_text=" +
                              search_text +
                              '">' +
                              __("Last") +
                              "</a></li>";
                          }

                          return paginationHtml;
                        }
                      </script>
                    </div>
                  </div>
                </div>
              </div>
              <div class="tab-pane" id="tab2"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="//cdn.jsdelivr.net/npm/sweetalert2@10"></script>
  <script>
    let id;
    const deleteButtons = document.querySelectorAll(".deleteRequest");
    deleteButtons.forEach((button) => {
      button.addEventListener("click", (e) => {
        const DataId = e.target.closest("[data-id]").getAttribute("data-id");
        id = DataId;
        console.log(DataId);
        event.preventDefault();
        confirmDelete(e.target.href);
        console.log("id");
      });
    });
    function confirmDelete(deleteUrl) {
      Swal.fire({
        title: '<%- __("Are you sure") -%>',
        text: '<%- __("You want to delete it") -%>',
        icon: '<%- __("warning") -%>',
        showCancelButton: true,
        confirmButtonColor: "#3085d6",
        cancelButtonColor: "#d33",
        confirmButtonText: '<%- __("Yes, delete it") -%>',
      }).then((result) => {
        if (result.isConfirmed) {
          window.location.href = `/admin/subscription/delete/${id}`;
        }
      });
    }
  </script>
</div>
